# attendance-hours 规范

## 目的
提供 Teams 打卡数据查询、双月合并过滤、工时与有效工作日计算，以及异常高亮与汇总指标展示的移动端能力。
## 需求
### 需求：查询打卡数据
系统必须通过 HTTP GET 请求 `https://im.360teams.com/api/qfin-api/securityapi/attendance/query/detail` 拉取打卡明细，并包含以下内容：
- 请求头：`User-Agent: Mozilla/5.0`，`AppKey: 360teams`，`Authorization`（来自用户输入）。
- 查询参数：`emCode`（来自用户输入），`attDate` 为空字符串，`cycle` 为查询月份（`YYYY-MM`）。
- 查询范围：对所选月份与其下月分别请求一次。
- 仅当两次请求均成功（HTTP 成功且 `code == 0`）时才更新页面数据。

#### 场景：按月份拉取
- **当** 用户选择某月并点击“查询/刷新”
- **那么** 系统分别请求该月与下月的数据，并在成功后进入后续清洗与统计

### 需求：合并过滤与字段映射
系统必须将两次请求返回的 `calendarList` 合并为记录列表，并按以下规则清洗：
- 字段映射：`日期=attDate`，`月份=attDate` 前 7 位，`假期flag=isrest`，`上班打卡=firstDate`，`下班打卡=endDate`，`备注=exp`，`备注2=resultList[0]`（列表为空则为 `null`）。
- 仅保留 `月份` 等于所选月份的记录。
- 按 `日期` 去重，保留第一条记录。

#### 场景：过滤到所选月份
- **当** 合并后的记录包含跨月数据
- **那么** 系统仅保留所选月份的记录并去重

### 需求：工时计算
系统必须按以下规则计算每日工时：
- `工时 = (下班打卡时间 - 上班打卡时间)` 换算为小时数。
- 上班或下班时间缺失、无法解析时，`工时` 记为 `0`。
- `假期flag != 0` 时，`工时` 记为 `0`。

#### 场景：正常打卡计算工时
- **当** 上下班时间均可解析且非假期
- **那么** 系统计算时间差并换算为小时数

### 需求：有效工作日计算
系统必须严格复刻以下有效工作日规则：
- `假期flag != 0` 时为 `0`。
- `备注` 为空/缺失或为 `迟到`、`早退` 时为 `1`。
- `备注` 为 `病假`、`年假`、`调休假` 时：`工时 > 0` 为 `0.5`，否则为 `0`。
- 其它情况：`备注2` 包含 `半天` 时为 `0.5`，否则为 `0`。

#### 场景：请假且有工时
- **当** 备注为 `病假` 且工时大于 0
- **那么** 系统将有效工作日记为 0.5

### 需求：统计指标与异常处理
系统必须基于“今天”之前的记录计算统计指标：
- 仅统计 `日期 < 今天(YYYY-MM-DD)` 的记录。
- `有效工作日 = 有效工作日` 列求和，`总有效工时 = 工时` 列求和。
- `平均工时 = 总有效工时 / 有效工作日`，四舍五入保留 2 位小数。
- 当 `有效工作日 == 0` 时，平均工时显示“异常”，不进行除法计算。

#### 场景：有效工作日为 0
- **当** 今天之前没有有效工作日
- **那么** 系统显示“平均工时：异常”

### 需求：设置与本地存储
系统必须提供 `emCode` 与 `Authorization` 输入，并持久化保存：
- 应用启动时自动读取本地存储并回填输入框。
- 用户修改后写入本地存储，后续查询使用最新值。

#### 场景：重启后自动回填
- **当** 用户已保存配置并重新打开应用
- **那么** 系统自动填充上次保存的 `emCode` 与 `Authorization`

### 需求：月份选择与查询控制
系统必须提供月份选择器与“查询/刷新”按钮：
- 默认选中当前月份。
- 点击“查询/刷新”触发数据拉取与统计刷新。

#### 场景：默认当前月
- **当** 用户首次进入页面
- **那么** 月份选择器显示当前月份

### 需求：概览仪表盘展示
系统必须在页面顶部展示以下核心指标：
- 平均工时
- 有效工作日
- 总有效工时

#### 场景：展示核心指标
- **当** 查询完成
- **那么** 系统在顶部展示三项指标数值

### 需求：明细列表与异常高亮
系统必须展示每日打卡明细，并对异常记录高亮：
- 明细至少包含：日期、上班打卡、下班打卡、工时、备注/备注2。
- `工时 <= 10.5` 视为工时不足，使用橙色高亮。
- 上班或下班时间缺失/无法解析视为缺卡，使用红色高亮。
- 若同时满足缺卡与工时不足，优先显示红色高亮。

#### 场景：工时不足高亮
- **当** 某日工时为 10.5 或以下且打卡时间完整
- **那么** 系统以橙色标记该条记录
