# attendance-hours 规范

## 目的
提供 Teams 打卡数据查询、双月合并过滤、工时与有效工作日计算，以及异常高亮与汇总指标展示的移动端能力。
## 需求
### 需求：查询打卡数据
系统必须通过 HTTP GET 请求 `https://im.360teams.com/api/qfin-api/securityapi/attendance/query/detail` 拉取打卡明细，并包含以下内容：
- 请求头：`User-Agent: Mozilla/5.0`，`AppKey: 360teams`，`Authorization`（来自用户输入）。
- 查询参数：`emCode`（来自用户输入），`attDate` 为空字符串，`cycle` 为查询月份（`YYYY-MM`）。
- 查询范围：对所选月份与其下月分别请求一次。
- 仅当两次请求均成功（HTTP 成功且 `code == 0`）时才更新页面数据。

#### 场景：按月份拉取
- **当** 用户选择某月并点击“查询/刷新”
- **那么** 系统分别请求该月与下月的数据，并在成功后进入后续清洗与统计

### 需求：合并过滤与字段映射
系统必须将两次请求返回的 `calendarList` 合并为记录列表，并按以下规则清洗：
- 字段映射：`日期=attDate`，`月份=attDate` 前 7 位，`假期flag=isrest`，`上班打卡=firstDate`，`下班打卡=endDate`，`备注=exp`，`备注2=resultList[0]`（列表为空则为 `null`）。
- 仅保留 `月份` 等于所选月份的记录。
- 按 `日期` 去重，保留第一条记录。

#### 场景：过滤到所选月份
- **当** 合并后的记录包含跨月数据
- **那么** 系统仅保留所选月份的记录并去重

### 需求：工时计算
系统必须按以下规则计算每日工时：
- `工时 = (下班打卡时间 - 上班打卡时间)` 换算为小时数。
- 上班或下班时间缺失、无法解析时，`工时` 记为 `0`。
- `假期flag != 0` 时，`工时` 记为 `0`。

#### 场景：正常打卡计算工时
- **当** 上下班时间均可解析且非假期
- **那么** 系统计算时间差并换算为小时数

### 需求：有效工作日计算
系统必须严格复刻以下有效工作日规则：
- `假期flag != 0` 时为 `0`。
- `备注` 为空/缺失或为 `迟到`、`早退` 时为 `1`。
- `备注` 为 `病假`、`年假`、`调休假` 时：`工时 > 0` 为 `0.5`，否则为 `0`。
- 其它情况：`备注2` 包含 `半天` 时为 `0.5`，否则为 `0`。

#### 场景：请假且有工时
- **当** 备注为 `病假` 且工时大于 0
- **那么** 系统将有效工作日记为 0.5

### 需求：统计指标与异常处理
系统必须基于“今天”之前的记录计算统计指标：
- 仅统计 `日期 < 今天(YYYY-MM-DD)` 且位于选定范围内的记录。
- `有效工作日 = 有效工作日` 列求和，`总有效工时 = 工时` 列求和。
- `平均工时 = 总有效工时 / 有效工作日`，四舍五入保留 2 位小数。
- 当 `有效工作日 == 0` 时，平均工时显示“异常”，不进行除法计算。

#### 场景：范围内无有效工作日
- **当** 选定范围内没有有效工作日
- **那么** 系统显示“平均工时：异常”

### 需求：设置与本地存储
系统必须提供 `emCode` 与 `Authorization` 输入，并持久化保存：
- 输入位置在“设置”页签。
- 应用启动时自动读取本地存储并回填输入框。
- 用户修改后写入本地存储，后续查询使用最新值。
- 主页仅展示当前 `emCode`，不显示输入框。

#### 场景：重启后自动回填
- **当** 用户已保存配置并重新打开应用
- **那么** 系统自动填充上次保存的 `emCode` 与 `Authorization`

### 需求：月份选择与查询控制
系统必须提供“年”与“月”视图的年月选择能力：
- 年视图提供“起始年月”与“结束年月”两个选择器，结束年月不得早于起始年月。
- 月视图提供单月选择器，默认选中当前月。
- 年视图默认范围为“当前月往前 11 个月”至“当前月”。

#### 场景：结束年月早于起始年月
- **当** 用户选择的结束年月早于起始年月
- **那么** 系统禁止确认并提示用户调整

### 需求：概览仪表盘展示
系统必须在图表视图内展示以下核心指标：
- 平均工时
- 有效工作日
- 总有效工时
- 指标数值必须随当前视图选择范围变化。

#### 场景：切换年月范围
- **当** 用户调整年视图的起始/结束年月
- **那么** 系统更新对应范围的概览指标数值

### 需求：明细列表与异常高亮
系统必须展示每日打卡明细，并对异常记录高亮：
- 明细至少包含：日期、上班打卡、下班打卡、工时、备注/备注2。
- `工时 <= 10.5` 视为工时不足，使用橙色高亮。
- 上班或下班时间缺失/无法解析视为缺卡，使用红色高亮。
- 若同时满足缺卡与工时不足，优先显示红色高亮。

#### 场景：工时不足高亮
- **当** 某日工时为 10.5 或以下且打卡时间完整
- **那么** 系统以橙色标记该条记录

### 需求：底部导航与页面分区
系统必须提供底部导航用于“主页”与“设置”分区：
- 主页展示当前工号、图表区与明细列表。
- 设置页提供 `emCode` 与 `Authorization` 的输入与保存。

#### 场景：从设置页返回主页
- **当** 用户在设置页保存配置并返回主页
- **那么** 主页显示当前工号

### 需求：图表视图切换
系统必须提供“年”与“月”的柱状图切换：
- 年视图显示按月平均工时柱状图，范围为起始/结束年月之间。
- 月视图显示按日平均工时柱状图，范围为选定月份。
- 切换后复用同一警戒线阈值规则。

#### 场景：切换到月视图
- **当** 用户切换到月视图
- **那么** 系统展示选定月份的按日柱状图

### 需求：拉取时间展示
系统必须在图表区域展示当前使用数据的拉取时间：
- 文案格式为 `当前使用数据拉取时间为yyyy-MM-dd hh:mm:ss`。
- 当无缓存时不显示该文案。

#### 场景：展示拉取时间
- **当** 本地存在近一年缓存数据
- **那么** 系统显示拉取时间文案

### 需求：iOS Liquid Glass 背景
系统必须在 iOS 平台使用 `expo-blur` 模拟 Liquid Glass 视觉效果：
- 全局背景采用磨砂玻璃质感，覆盖主要页面内容背景。
- 非 iOS 平台保持现有浅色背景，不应用玻璃材质。

#### 场景：iOS 启用玻璃背景
- **当** 用户在 iOS 设备打开应用
- **那么** 页面显示玻璃质感背景

### 需求：iOS 暗夜模式跟随系统
系统必须在 iOS 平台跟随系统暗夜模式切换主题：
- 系统进入暗夜模式时，应用主题同步变暗。
- 系统回到浅色模式时，应用主题同步恢复浅色。
- 非 iOS 平台不跟随系统暗夜模式。

#### 场景：iOS 系统切换暗夜模式
- **当** iOS 系统切换为暗夜模式
- **那么** 应用主题自动切换为暗色主题

### 需求：近一年数据拉取与缓存
系统必须支持按“近一年”批量拉取并覆盖本地缓存：
- 覆盖范围为包含当前月在内的最近 12 个月。
- 点击“近一年拉取”按钮后，使用当前 `emCode` 与 `Authorization` 逐月请求并覆盖本地缓存。
- 拉取成功后更新“数据拉取时间”为 `YYYY-MM-DD hh:mm:ss`。
- 若无本地缓存数据，界面显示“待拉取”。

#### 场景：首次无缓存
- **当** 用户首次进入应用且本地无近一年缓存
- **那么** 系统显示“待拉取”提示并不展示图表数据

### 需求：警戒线阈值与柱子配色
系统必须提供可配置的警戒线阈值：
- 默认阈值为 `10.5`。
- 用户修改阈值后，虚线位置实时更新。
- 柱子高度大于或等于阈值时为绿色，小于阈值时为红色。

#### 场景：调整阈值
- **当** 用户将阈值修改为新的数值
- **那么** 虚线位置与柱子颜色实时更新

### 需求：日维度平均工时计算
系统必须按如下规则生成日维度柱状图数据：
- 柱高 = `工时 / 有效工作日`。
- 若 `有效工作日 = 0`，该日不显示在图表中。
- 当 `有效工作日 = 0.5` 时，显示“半天有效工时”提示。

#### 场景：半天有效工作日提示
- **当** 某日 `有效工作日 = 0.5`
- **那么** 系统在该日柱状图上显示“半天有效工时”提示

